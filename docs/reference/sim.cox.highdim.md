# Simulate stratified Cox PH survival data with flexible censoring, optional binary covariates, and optional ties

Internal function to generate time-to-event data under a stratified Cox
proportional hazards model with high-dimensional covariates,
stratum-specific multiplicative baseline scaling, and controllable
random censoring. Event times are generated by inverse transform
sampling using the baseline cumulative hazard.

The model is \$\$h(t \mid Z, s) = \gamma_s \\ h_0(t)\\ \exp(Z^\top
\beta),\$\$ where \\\gamma_s\\ is a stratum-specific positive constant,
\\h_0(t)\\ is the baseline hazard, and \\\beta\\ is the coefficient
vector.

Supported baseline hazards:

- `"exponential"`: \\h_0(t)=1\\, so \\H_0(t)=t\\.

- `"weibull"`: \\h_0(t)=\alpha t\\ with \\\alpha\>0\\, so
  \\H_0(t)=\alpha t^2/2\\.

Censoring is implemented as \$\$T\_{\mathrm{obs}} = \min(T, C,
\texttt{max_time}),\$\$ where \\C\\ is a random censoring time drawn
from a specified distribution and calibrated to approximately match the
target censoring rate.

Supported random censoring distributions:

- `"uniform"`: \\C \sim \mathrm{Unif}(0, c\_{\max})\\.

- `"exponential"`: \\C \sim \mathrm{Exp}(\lambda_c)\\.

- `"weibull"`: \\C \sim \mathrm{Weibull}(k, \lambda_c)\\, with shape
  \\k\\ specified by `censor_weibull_shape`.

- `"lognormal"`: \\C \sim \mathrm{LogNormal}(\mu_c, \sigma_c^2)\\, with
  \\\sigma_c\\ specified by `censor_lognormal_sdlog`.

- `"none"`: no random censoring; only administrative censoring via
  `max_time`.

Binary covariates can be specified by index via `binary_idx`. These
variables are generated using a latent Gaussian threshold model to
achieve a desired prevalence and an approximate within-binary
correlation controlled by `rho_binary`. Specifically, if \\B\\ is binary
with \\P(B=1)=p\\, it is generated as \\B = I(L \> c)\\ where \\L\\ is
standard normal and \\c=\Phi^{-1}(1-p)\\. When multiple binary
covariates are requested, their latent variables are generated jointly
with an equicorrelation `rho_binary`. This controls latent (tetrachoric)
correlation; the resulting Pearson correlation among binary variables is
constrained by prevalence and will generally be close but not identical
to `rho_binary`.

If `ties=TRUE`, observed times are discretized into `ties_levels` bins
(based on sample quantiles) and replaced by bin midpoints to induce tied
event/censoring times. Smaller `ties_levels` produces stronger ties.

## Usage

``` r
sim.cox.highdim(
  n_stratum = 1,
  n.beta,
  beta_value_vec,
  beta_idx = NULL,
  mu_Z = NULL,
  sd_Z = NULL,
  stratum_size = 1000,
  rho = 0.1,
  censor_rate = 0.3,
  censor_type = c("uniform", "exponential", "weibull", "lognormal", "none"),
  max_time = Inf,
  seed = NULL,
  baseline = c("exponential", "weibull"),
  alpha = NULL,
  censor_weibull_shape = 1.5,
  censor_lognormal_sdlog = 1,
  binary_idx = integer(0),
  binary_prev = 0.5,
  rho_binary = 0.1,
  ties = FALSE,
  ties_levels = 50
)
```

## Arguments

- n_stratum:

  Integer. Number of strata.

- n.beta:

  Integer. Total number of covariates \\p\\.

- beta_value_vec:

  Numeric vector. True coefficients for the first
  `length(beta_value_vec)` covariates. Remaining coefficients (up to
  `n.beta`) are set to 0.

- beta_idx:

  Integer vector or `NULL`. Indices (in `1:n.beta`) of covariates with
  nonzero true coefficients. If `NULL`, defaults to
  `1:length(beta_value_vec)` (the original behavior). Must have the same
  length as `beta_value_vec` after filtering to valid indices.

- mu_Z:

  Numeric vector or `NULL`. Mean vector for the continuous covariates.
  If `NULL`, a zero vector is used. For indices in `binary_idx`, `mu_Z`
  is ignored.

- stratum_size:

  Integer or numeric vector. Stratum sample sizes. If a scalar, it is
  recycled to length `n_stratum`; if a vector, it must have length
  `n_stratum`.

- rho:

  Numeric. Correlation parameter in \\\[0,1)\\ for the equicorrelation
  covariance structure used to generate continuous covariates.

- censor_rate:

  Numeric. Target random censoring rate in \\\[0,1)\\. If 0, no random
  censoring is applied (administrative censoring via `max_time` may
  still apply).

- censor_type:

  Character. Random censoring distribution. One of `"uniform"`,
  `"exponential"`, `"weibull"`, `"lognormal"`, or `"none"`.

- max_time:

  Numeric. Administrative censoring time. Observed time is
  `min(event, censor, max_time)`.

- seed:

  Integer or `NULL`. Random seed for reproducibility.

- baseline:

  Character. Baseline hazard type. One of `"exponential"` or
  `"weibull"`.

- alpha:

  Numeric or `NULL`. Required when `baseline="weibull"`. Controls the
  Weibull baseline hazard \\h_0(t)=\alpha t\\; must be positive and
  finite. Ignored when `baseline="exponential"`.

- censor_weibull_shape:

  Numeric. Shape parameter \\k\>0\\ for Weibull random censoring when
  `censor_type="weibull"`. The scale parameter is calibrated internally
  to match `censor_rate`. Ignored otherwise.

- censor_lognormal_sdlog:

  Numeric. Log-scale standard deviation \\\sigma_c\>0\\ for log-normal
  random censoring when `censor_type="lognormal"`. The mean on the log
  scale is calibrated internally to match `censor_rate`. Ignored
  otherwise.

- binary_idx:

  Integer vector. Indices (in `1:n.beta`) of covariates to be generated
  as binary. Default is none (all covariates continuous).

- binary_prev:

  Numeric scalar or vector. Prevalence \\P(Z_j=1)\\ for binary
  covariates. If a scalar, it is recycled to all binary covariates. Must
  be in \\(0,1)\\.

- rho_binary:

  Numeric. Equicorrelation parameter in \\\[0,1)\\ for the latent
  Gaussian vector used to generate binary covariates. Ignored if
  `binary_idx` is empty.

- ties:

  Logical. If `TRUE`, discretize observed times to induce ties.

- ties_levels:

  Integer. Number of bins used to discretize time when `ties=TRUE`.
  Smaller values yield stronger ties. Must be \\\ge 2\\.

## Value

A list with components:

- `data_combined`: A `data.frame` with columns `stratum`, `status`,
  `time`, and covariates `Z1...Zp`.

- `data`: A list containing `stratum`, `Z`, `time`, and `status`.

- `true_beta`: Numeric vector of length `n.beta` with the true
  coefficients used.

- `meta`: A list of metadata including stratum parameters, baseline
  settings, censoring configuration, binary-covariate configuration,
  ties configuration, and the actual censoring rate achieved.

## Details

Continuous covariates (those not in `binary_idx`) are generated
independently within each stratum from a multivariate normal
distribution with mean given by `mu_Z` (restricted to the continuous
indices) and an equicorrelation covariance matrix with diagonal 1 and
off-diagonal `rho`.

Stratum-specific scaling factors are sampled as \\\gamma_s \sim
\mathrm{Unif}(0,2)\\ and applied multiplicatively to the hazard.

For `baseline="weibull"`, the implied event-time distribution
(conditional on \\Z\\ and stratum) is Weibull with shape 2 under the
parameterization \\h_0(t)=\alpha t\\.
