% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/coxkl_ties.R
\name{coxkl_ties}
\alias{coxkl_ties}
\title{Cox Proportional Hazards Model with KL Divergence for Data Integration (Ties Handling)}
\usage{
coxkl_ties(
  z,
  delta,
  time,
  stratum = NULL,
  beta,
  etas,
  ties = "breslow",
  tol = 1e-04,
  Mstop = 100,
  message = FALSE,
  data_sorted = FALSE,
  beta_initial = NULL,
  comb_max = 1e+07
)
}
\arguments{
\item{z}{Numeric matrix of covariates. Rows represent observations, columns represent predictor variables.}

\item{delta}{Numeric vector of event indicators (1 = event, 0 = censored).}

\item{time}{Numeric vector of observed event or censoring times.}

\item{stratum}{Optional numeric or factor vector defining strata.}

\item{beta}{Numeric vector of external coefficients. Length must equal the number of columns in \code{z}.
These are used to compute the external risk scores and the KL divergence term.}

\item{etas}{Numeric vector of tuning parameters. Controls the reliance on external information.
The function will sort these values and fit a model for each.}

\item{ties}{Character string specifying the method for handling ties. Must be one of
\code{"breslow"} (default) or \code{"exact"}.}

\item{tol}{Numeric. Convergence tolerance for the optimization algorithm (Newton-Raphson). Default is \code{1e-4}.}

\item{Mstop}{Integer. Maximum number of iterations for the optimization. Default is \code{100}.}

\item{message}{Logical. If \code{TRUE}, prints progress messages (e.g., progress bar) during fitting. Default is \code{FALSE}.}

\item{data_sorted}{Logical. Internal use. If \code{TRUE}, assumes data is already sorted by stratum and time.}

\item{beta_initial}{Optional numeric vector. Initial values for the coefficients for the first \code{eta}. Default is zero vector.}

\item{comb_max}{Integer. Maximum number of combinations to check for the \strong{Exact} partial likelihood calculation,
preventing excessive computation time. Default is \code{1e7}. Only relevant if \code{ties = "exact"}.}
}
\value{
An object of class \code{"coxkl"} containing:
\describe{
\item{\code{eta}}{The sorted sequence of \eqn{\eta} values used.}
\item{\code{beta}}{Matrix of estimated coefficients (\eqn{p \times n_{etas}}). Columns correspond to \code{eta} values.}
\item{\code{linear.predictors}}{Matrix of linear predictors (risk scores) for each \code{eta}.}
\item{\code{likelihood}}{Vector of negative log-partial likelihoods for each \code{eta}.}
\item{\code{data}}{List containing the input data used (\code{z}, \code{time}, \code{delta}, \code{stratum}).}
}
}
\description{
Fits a series of Cox proportional hazards models that integrate external information,
specified as external coefficients (\code{beta}), using Kullbackâ€“Leibler (KL) divergence.
This version of the function is designed to \strong{handle tied event times} using either
the Breslow or Exact partial likelihood approximation.

The strength of integration is controlled by a sequence of tuning parameters (\code{etas}).
The function fits a model for each \code{eta} value provided.
}
\details{
The objective function is a weighted combination of the internal partial likelihood
and the KL divergence from the external information derived from \code{beta}.

\itemize{
\item \strong{KL Divergence and Weighting}: Larger values of \code{eta} place more weight
on matching the risk set behavior implied by the external coefficients.
\item \strong{Standard Cox}: \code{eta = 0} corresponds to the standard Cox model, relying
solely on the internal partial likelihood.
\item \strong{Ties Handling}: The calculation of the partial likelihood uses the method
specified by the \code{ties} argument ("breslow" or "exact"). The exact method may be
computationally intensive for datasets with many tied events.
}

The function uses a "warm start" strategy where the solution for the current \code{eta}
is used as the initial value for the next \code{eta} in the sorted sequence.
}
\examples{
\dontrun{
# Load example data
data(ExampleData_lowdim)
train_dat_lowdim <- ExampleData_lowdim$train
train_dat_lowdim$time <- round(train_dat_lowdim$time, 2)   # Rounding time introduces ties for demonstration

eta_list <- generate_eta(method = "exponential", n = 50, max_eta = 50)

# 1. Fit the model using Breslow's approximation for ties (Default)
coxkl_ties.fit_Breslow <- coxkl_ties(
    z = train_dat_lowdim$z,
    delta = train_dat_lowdim$status,
    time = train_dat_lowdim$time,
    stratum = train_dat_lowdim$stratum,
    beta = ExampleData_lowdim$beta_external_fair,
    etas = eta_list,
    ties = "breslow"
)

# 2. Fit the model using the Exact method for ties
coxkl_ties.fit_Exact <- coxkl_ties(
    z = train_dat_lowdim$z,
    delta = train_dat_lowdim$status,
    time = train_dat_lowdim$time,
    stratum = train_dat_lowdim$stratum,
    beta = ExampleData_lowdim$beta_external_fair,
    etas = eta_list,
    ties = "exact"
)
}

}
