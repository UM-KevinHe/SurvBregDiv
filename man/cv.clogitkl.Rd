% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/cv.clogitkl.R
\name{cv.clogitkl}
\alias{cv.clogitkl}
\title{Cross-Validated Conditional Logistic Regression with KL Integration}
\usage{
cv.clogitkl(
  y,
  z,
  stratum,
  beta = NULL,
  etas = NULL,
  method = c("breslow", "exact"),
  tol = 1e-04,
  Mstop = 100,
  nfolds = 5,
  criteria = c("loss", "AUC", "Brier"),
  message = FALSE,
  seed = NULL,
  comb_max = 1e+07,
  ...
)
}
\arguments{
\item{y}{Numeric vector of binary outcomes (0 = control, 1 = case).
In the 1:m matched case–control setting, each stratum must contain exactly
one case.}

\item{z}{Numeric matrix of covariates (rows = observations, columns = variables).}

\item{stratum}{Numeric or factor vector defining the matched sets (strata).
Each unique value identifies one matched set.}

\item{beta}{Numeric vector of external coefficients. \strong{Required}.
Length must equal the number of columns in \code{z}. These are used by
\code{\link{clogitkl}} / \code{\link{coxkl_ties}} to construct the KL
divergence penalty.}

\item{etas}{Numeric vector of candidate tuning values for the integration
parameter \eqn{\eta} to be cross-validated. The values will be sorted in
ascending order.}

\item{method}{Character string specifying the tie-handling method used in the
underlying Cox partial likelihood. Must be one of \code{"breslow"} or
\code{"exact"}. For 1:m matched sets, these yield identical parameter
estimates, but \code{"exact"} is theoretically preferable.}

\item{tol}{Convergence tolerance for the optimizer used inside
\code{\link{clogitkl}} / \code{\link{coxkl_ties}}. Default \code{1e-4}.}

\item{Mstop}{Maximum number of Newton iterations used inside
\code{\link{clogitkl}} / \code{\link{coxkl_ties}}. Default \code{100}.}

\item{nfolds}{Number of cross-validation folds. Default \code{5}. Folds are
constructed at the stratum level using \code{\link{get_fold_cc}}.}

\item{criteria}{Character string specifying the CV performance criterion.
Choices are:
\itemize{
\item \code{"loss"}: Average negative conditional log-likelihood
(lower is better).
\item \code{"AUC"}: Matched-set AUC based on within-stratum comparisons
(higher is better).
\item \code{"Brier"}: Conditional Brier score using within-stratum
softmax probabilities (lower is better).
}
Default is \code{"loss"}.}

\item{message}{Logical; if \code{TRUE}, prints progress messages and fold-wise
evaluation progress bars. Default \code{FALSE}.}

\item{seed}{Optional integer seed for reproducible fold assignment. Default
\code{NULL}.}

\item{comb_max}{Integer. Maximum number of combinations for the
\code{method = "exact"} calculation, passed down to
\code{\link{clogitkl}} / \code{\link{coxkl_ties}}. Default \code{1e7}.}

\item{...}{Additional arguments (currently ignored).}
}
\value{
A \code{list} of class \code{"cv.coxkl"} containing:
\describe{
\item{\code{internal_stat}}{A \code{data.frame} with one row per \code{eta}
and the CV metric results for the chosen \code{criteria}.}
\item{\code{beta_full}}{The matrix of coefficients from the full-data fit
(columns correspond to \code{etas}).}
\item{\code{best}}{A list containing the \code{best_eta}, the corresponding
\code{best_beta} from the full-data fit, and the \code{criteria} used.}
\item{\code{criteria}}{The criterion used for selection.}
\item{\code{nfolds}}{The number of folds used.}
}
}
\description{
Performs K-fold cross-validation (CV) to select the integration parameter
\code{eta} for Conditional Logistic Regression with Kullback–Leibler (KL)
divergence data integration, implemented via \code{\link{clogitkl}}.

This function is designed for 1:m matched case–control settings where each
stratum (matched set) contains exactly one case and \eqn{m} controls.
}
\details{
The matched case–control problem is handled via \code{\link{clogitkl}}, which
maps Conditional Logistic Regression to a Cox model with fixed event time and
uses \code{\link{coxkl_ties}} as the core engine.

Cross-validation is performed at the stratum level: each matched set is
treated as an indivisible unit and assigned to a single fold using
\code{\link{get_fold_cc}}. This ensures that the conditional likelihood is
well-defined within each training and test split.

The \code{criteria} argument controls the CV performance metric:
\itemize{
\item \code{"loss"}: Average negative conditional log-likelihood on held-out
strata. For each fold, the conditional log-likelihood is computed over
the test matched sets using the fitted \eqn{\hat\beta} from the
corresponding training data; the fold-wise losses are then averaged.
\item \code{"AUC"}: A matched-set AUC based on within-stratum comparisons.
For each stratum, the case score is compared to the control scores,
counting concordant/discordant/tied pairs and aggregating across all
strata. Higher AUC indicates better discrimination.
\item \code{"Brier"}: A conditional Brier score based on within-stratum
softmax probabilities. For each stratum, a probability is assigned to
each member via
\eqn{\hat p_{si} = \exp(\eta_{si}) / \sum_{j \in S_s} \exp(\eta_{sj})},
and the Brier score is the mean squared error
\eqn{(Y_{si} - \hat p_{si})^2} across all observations. Lower Brier
indicates better conditional calibration and sharpness.
}

The returned object has the same structure as \code{"cv.coxkl"} objects from
\code{\link{cv.coxkl_ties}}, facilitating downstream code reuse.
}
\examples{
\dontrun{
data(ExampleData_cc)
train_cc <- ExampleData_cc$train

y        <- train_cc$y
z        <- train_cc$z
sets     <- train_cc$stratum
beta_ext <- ExampleData_cc$beta_external

eta_list <- generate_eta(method = "exponential", n = 50, max_eta = 10)

cv_clr_kl <- cv.clogitkl(
  y        = y,
  z        = z,
  stratum  = sets,
  beta     = beta_ext,
  etas     = eta_list,
  method   = "exact",
  nfolds   = 5,
  criteria = "loss",
  seed     = 42
)

cv_clr_kl$best$best_eta
}

}
\seealso{
\code{\link{clogitkl}} for Conditional Logistic KL fitting,
\code{\link{coxkl_ties}} for the underlying Cox–KL engine, and
\code{\link{get_fold_cc}} for stratum-level fold construction in
matched case–control studies.
}
